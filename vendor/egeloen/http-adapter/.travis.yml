language: php

php:
    - 5.3.3
    - 5.3
    - 5.4
    - 5.5
    - 5.6
    - hhvm
    - hhvm-nightly

env:
    global:
        - TEST_SERVER=http://localhost:10000/server.php
        - PHP_FCGI_CHILDREN=10
        - ENABLE_CURL=true
        - SYMFONY_VERSION=2.3.*
        - GUZZLE_HTTP_VERSION=5.*

before_install:
    - sudo apt-get update
    - sudo apt-get install apache2 libapache2-mod-fastcgi
    - sudo a2enmod actions fastcgi alias
    - if [[ "$TRAVIS_PHP_VERSION" != hhvm* ]]; then sudo cp -f tests/Fixtures/etc/apache-php.conf /etc/apache2/sites-available/default; fi
    - if [[ "$TRAVIS_PHP_VERSION" = hhvm* ]]; then sudo cp -f tests/Fixtures/etc/apache-hhvm.conf /etc/apache2/sites-available/default; fi
    - sudo sed -i "s?%SERVER_DIR%?$(pwd)/tests/Fixtures?g" /etc/apache2/sites-available/default
    - sudo service apache2 restart
    - if [[ "$ENABLE_CURL" = false ]]; then mkdir -p ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d; fi
    - if [[ "$ENABLE_CURL" = false ]]; then echo "disable_functions = curl_init" >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini; fi
    - if [[ "$TRAVIS_PHP_VERSION" = "5.6" ]]; then echo "always_populate_raw_post_data = -1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini; fi
    - if [[ "$TRAVIS_PHP_VERSION" = "5.3" ]]; then sudo cp ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf.default ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf; fi
    - if [[ "$TRAVIS_PHP_VERSION" = "5.3" ]]; then ~/.phpenv/versions/$(phpenv version-name)/sbin/php-fpm; fi
    - if [[ "$TRAVIS_PHP_VERSION" != "5.3" && "$TRAVIS_PHP_VERSION" != hhvm* ]]; then php-cgi -b 127.0.0.1:9000 & fi
    - if [[ "$TRAVIS_PHP_VERSION" = hhvm* ]]; then hhvm --mode server -vServer.Type=fastcgi -vServer.Port=9000 -vServer.FixPathInfo=true & fi

before_script:
    - composer self-update
    - composer require --no-update symfony/event-dispatcher:${SYMFONY_VERSION}
    - composer require --no-update --dev guzzlehttp/guzzle:${GUZZLE_HTTP_VERSION}
    - if [[ "$TRAVIS_PHP_VERSION" = 5.3* ]]; then composer remove guzzlehttp/guzzle --dev --no-update; fi
    - if [[ "$TRAVIS_PHP_VERSION" = "5.3.3" ]]; then composer remove zendframework/zendframework --dev --no-update; fi
    - composer install --prefer-source

script: bin/phpunit --coverage-clover clover.xml

after_script:
    - sed -i "/^disable_functions =.*$/d" ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini
    - bin/coveralls

matrix:
    include:
        - php: 5.5
          env: ENABLE_CURL=false
        - php: 5.5
          env: GUZZLE_HTTP_VERSION=4.*
        - php: 5.5
          env: SYMFONY_VERSION=2.1.*
        - php: 5.5
          env: SYMFONY_VERSION=2.2.*
        - php: 5.5
          env: SYMFONY_VERSION=2.4.*
        - php: 5.5
          env: SYMFONY_VERSION=2.5.*
        - php: 5.5
          env: SYMFONY_VERSION=dev-master
    allow_failures:
        - php: hhvm
        - php: hhvm-nightly
        - env: SYMFONY_VERSION=dev-master

notifications:
    email: geloen.eric@gmail.com
